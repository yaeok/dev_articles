---
title: "友達検索・追加機能を実装"
free: false
---

## はじめに
この章では、友達検索と友達追加機能について実装、解説をしていきたいと思います。
ゴールとしては、友達検索画面から、名前を入力して友達検索を行います。
検索条件は、部分一致でも検索ができるようにしたいと思います。
検索結果をTableで表示し、「追加」ボタンを押すと友達が追加され、チャットを始めることができるように実装していきます。イメージはできましたでしょうか？

それでは、実装にうつっていきましょう。

## 友達検索画面の実装
まずは、`app/home/add`フォルダを作成し、直下に`page.tsx`を作成します。
```typescript: app/home/add/page.tsx
```

検索ボタンを押すと、Firestoreからユーザ情報を取得して検索をかけるような処理にします。
Firestoreでは`where`句を使用してデータを取得することが可能ですが、完全一致でないと取得することができません。
そのため、今回は、ユーザ情報をすべて取得し、取得してきたデータに対して部分一致検索を実施して絞り込みを実装していきます。
```typescript: lib/apis/user.ts
```

これで、検索ワードと部分一致したユーザ情報を取得することができました。
次に、取得してきたデータを検索画面に表示させましょう。
```typescript: app/home/add/page.tsx
```

これで検索画面の実装完了しました。次のセクションでは「追加」ボタン押下後の処理を実装します。

## 友達追加処理の実装
「追加」ボタンを押下した後の処理について実装していきます。
友達になるという判定は、データの構造上、ログインユーザと友達になるユーザのdocument直下に`friends`コレクションを追加して、その中に相手のdocumentを追加していくことで実現できます。
下記のようなデータ構造によってお互いが友達だと認識することができます。
```例
Aさんのデータ
users /
 uid {document} / 
  Aさん
   friends /
    Bさんuid {document}
    
Bさんのデータ
users / 
 uid {document} /
  Bさん
   friends / 
    Aさんuid {document}
```

「追加」ボタンを押した後の処理は以下のようになります。
```typescript: lib/apis/user.ts
```

これで双方が友達であることがわかるようになりました。
また、友達になったら、チャットができるようにしたいので、この処理のタイミングで、チャットルームを作成します。友達を追加したらチャットルームも作成します。
```typescript: lib/apis/chat.ts
```

登録したfieldから、チャットルームのIdとこのルームの中ではAさんとBさんがチャットしている場所だよっというのがわかります。

これでチャットをするためのマッチングができました。
最後に、ホーム画面のデータを少し修正していきます。現状だと、ダミーのデータを、Listで表示していました。今は、Firebaseとつなげているので、Firestoreから友達データをすべて取得して、そのデータをListで表示できるように修正していきましょう。
```typescript: app/home/page.tsx
```

この状態で画面を確認してみましょう。
※事前にユーザ情報を直接Firestoreに格納するか、Googleアカウントを2つ作成して、片方のユーザで、ログインして友達追加をしてみてください
[画像]

Firestoreにデータが格納しているかも確認してみましょう。

これで自分の友達情報をみることができ、相手のデータにも自分のデータが格納されていることを確認できました。最後にListをタップして画面遷移ができることまで確認ができたらOKです！

次の章ではいよいよチャットの送信機能の実装にうつります。