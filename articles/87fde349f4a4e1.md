---
title: "cloud functionsã§GMailã‚’é€ä¿¡ã™ã‚‹"
emoji: "ğŸ•Œ"
type: "tech"
topics:
  - "firebase"
  - "firestore"
  - "nextjs"
  - "cloudfunctions"
published: true
published_at: "2023-08-22 01:03"
---

# ã¯ã˜ã‚ã«
é–‹ç™ºä¸­ã®ã‚¢ãƒ—ãƒªã«ãŠå•ã„åˆã‚ã›ç”»é¢ã‚’ã„ã‚Œã¦ãŠå•åˆã›ãŒã‚ã£ãŸå ´åˆã€è‡ªå‹•ã§ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚ãã®æ™‚ã«ã€ã¡ã‚‡ã£ã¨æ‰‹ã“ãšã£ãŸã®ã§ã€å‚™å¿˜éŒ²ã‚’æ®‹ã—ã¦ãŠãã¾ã™ã€‚
ã‚ã¨ã€çµæ§‹ã„ã„æ„Ÿã˜ã®è‡ªå‹•åŒ–ã§ã€ã„ã‚ã‚“ãªå ´é¢ã§ä½¿ãˆãã†ã ã£ãŸã®ã§ã€èª°ã‹ã®ãŠå½¹ã«ç«‹ã¦ã‚‹ã¨å¹¸ã„ã§ã™ã€‚

# ãƒ•ãƒ­ãƒ¼
å‡¦ç†ã®æµã‚Œã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```
1, ãŠå•åˆã›ç”»é¢ã‹ã‚‰å•ã„åˆã‚ã›æƒ…å ±ãŒé€ä¿¡
2, firestoreã®contactsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ç™»éŒ²
3, ç™»éŒ²ã•ã‚ŒãŸã“ã¨ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«functionsã§å‡¦ç†
4, Gmailã§ãŠå•åˆã›å†…å®¹ãŒé€ä¿¡ã•ã‚Œã‚‹
```

# ç”»é¢ã®å®Ÿè£…
ã“ã“ã¯ã€ãã“ã¾ã§é‡è¦ã˜ã‚ƒãªã„ã§ã™ãŒã€ä¸€å¿œè¼‰ã›ã¦ãŠãã¾ã™ã€‚
`Next.js`ã¨`Chakra-ui`ã€`react-hook-form`ã‚’ä½¿ã£ã¦ãŠå•åˆã›ãƒ•ã‚©ãƒ¼ãƒ ã‚’å®Ÿè£…ã—ã¦ã¾ã™ã€‚
```typescript
'use client'

import { useRouter } from 'next/navigation'
import { useForm } from 'react-hook-form'

import {
  Box,
  Button,
  Flex,
  FormLabel,
  Heading,
  Input,
  Textarea,
  useToast,
  VStack,
} from '@/common/design'
import { validateContactScreen } from '@/common/utils/validate'
import { postContact } from '@/lib/firebase/api/contacts'

/** ãŠå•ã„åˆã‚ã›é€ä¿¡ç”»é¢
 * @screenname PostContactScreen
 * @description ãŠå•ã„åˆã‚ã›ã‚’é€ä¿¡ã™ã‚‹ç”»é¢
 */
export default function PostContactScreen() {
  const router = useRouter()
  const toast = useToast()
  const { handleSubmit, register } = useForm()
  const onSubmit = handleSubmit(async (data) => {
    const result = validateContactScreen({
      title: data.title,
      content: data.content,
    })

    if (result.isSuccess) {
      await postContact({ title: data.title, content: data.content }).then(
        (res) => {
          if (res.isSuccess) {
            toast({
              title: res.message,
              description: 'è²´é‡ãªã”æ„è¦‹ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™',
              status: 'success',
              duration: 2000,
              isClosable: true,
            })
            router.back()
          } else {
            toast({
              title: res.message,
              status: 'error',
              duration: 2000,
              isClosable: true,
            })
          }
        }
      )
    } else {
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
      toast({
        title: result.message,
        status: 'error',
        duration: 2000,
        isClosable: true,
      })
    }
  })
  return (
    <Flex flexDirection='column' width='100%' gap='24px' paddingY='5px'>
      <Heading fontSize='22px'>ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ </Heading>
      <form onSubmit={onSubmit}>
        <VStack alignItems='left'>
          <Box>
            <FormLabel htmlFor='title' textAlign='start'>
              ã‚¿ã‚¤ãƒˆãƒ«
            </FormLabel>
            <Input id='title' {...register('title')} />
          </Box>
          <Box>
            <FormLabel htmlFor='content' textAlign='start'>
              ãŠå•ã„åˆã‚ã›å†…å®¹
            </FormLabel>
            <Textarea id='content' {...register('content')} />
          </Box>

          <Button
            marginTop='4'
            colorScheme='teal'
            type='submit'
            paddingX='auto'
          >
            é€ä¿¡
          </Button>
          <Button marginTop='4' paddingX='auto' onClick={() => router.back()}>
            æˆ»ã‚‹
          </Button>
        </VStack>
      </form>
    </Flex>
  )
}

```

firestoreã¸ã®æ ¼ç´ã¯ã€ä»¥ä¸‹ã«ãªã‚Šã¾ã™
```typescript
/**
 * ãŠå•åˆã›ã®é€ä¿¡
 * @param title
 * @param content
 * @returns Promise<FirebaseResult>
 */
export const postContact = async (args: {
  title: string
  content: string
}): Promise<FirebaseResult> => {
  let result: FirebaseResult = {
    isSuccess: false,
    message: '',
  }
  const user = auth.currentUser
  const colRef = collection(db, 'contacts')
  const userInfo = await getUserInfoByUid({ uid: user!.uid })
  if (userInfo) {
    await addDoc(colRef, {
      contactTitle: args.title,
      contactContent: args.content,
      createdAt: serverTimestamp(),
      contactFrom: {
        uid: userInfo.uid,
        username: userInfo.username,
        email: userInfo.email,
      },
    }).then(() => {
      result = {
        isSuccess: true,
        message: 'ãŠå•ã„åˆã‚ã›ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚',
      }
    })
  } else {
    result = {
      isSuccess: false,
      message: 'ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
    }
  }
  return result
}
```


ãã®å¾Œã®ãŠå•åˆã›å¯¾å¿œã«ã‚‚ä½¿ãˆãã†ãªã®ã§ã€ãŠå•åˆã›ã‚’é€ä¿¡ã—ã¦ãã‚ŒãŸæ–¹ã®æƒ…å ±ã‚‚ç™»éŒ²ã—ã¦ã¾ã™ã€‚

ã§ã¯ã€cloud functionsã‚’ä½¿ç”¨ã—ã¦ã€`contacts`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ç™»éŒ²ã•ã‚ŒãŸã“ã¨ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«GmailãŒé€ä¿¡ã•ã‚Œã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

# functionsã®å®Ÿè£…
functionsã¯`typescript`ã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚
Gmailã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã«ã€ã€ŒNodemailerã€ã¨ã„ã†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å…¥ã‚Œã¦ã„ãã¾ã™ã€‚
[Nodemailer](https://nodemailer.com/about/)

çµè«–ã‹ã‚‰è¨€ã†ã¨ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚‰ã™ãã«ã§ãã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
ã‚³ãƒ¼ãƒ‰ã‚’ã–ã£ã¨å®Ÿè£…ã—ã¾ã—ãŸãŒã€çµæœé€ä¿¡ã•ã‚Œãšãƒ»ãƒ»ãƒ»é€”æ–¹ã«æš®ã‚Œã¦ã„ã‚‹ã¨ä¸‹è¨˜ã®è¨˜äº‹ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚
https://dev.classmethod.jp/articles/nodemailer-gmail/

>çµè«–ã‹ã‚‰å…ˆã«æ›¸ãã¨ã€åŸ·ç­†æ™‚ç¾åœ¨ã§ã¯Gmailã§é€ã‚‹éš›ã«
>2æ®µéšèªè¨¼ã‚’è¨­å®šã—ã¦ã‚ã‚‹ã“ã¨
>ã‚¢ãƒ—ãƒªã§ä½¿ã†ã€Œã‚¢ãƒ—ãƒªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ã‚’è¨­å®šã—ã€ãã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨
>ãŒå¿…è¦ãªã‚ˆã†ã§ã™ã€‚

ã‚‰ã—ã„ã§ã™ã€‚ãã®ãŸã‚ã€å®Ÿè£…å‰ã«ã€ã“ã‚Œã‚‚è¨­å®šã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚
è¨­å®šãŒã§ããŸã‚‰ã€ä¸‹è¨˜ã‚³ãƒ¼ãƒ‰ã‚’deployã—ã¾ã—ã‚‡ã†ã€‚
```typescript
/** Gmailé€ä¿¡ç”¨ã®è¨­å®šå¤‰æ•° */
let transporter = nodemailer.createTransport({
  service: 'Gmail',
  auth: {
    user: {è¨­å®šã—ãŸemail},
    pass: {è¨­å®šã—ãŸã‚¢ãƒ—ãƒªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰},
  },
})
/** firestoreã®contactsã«æ–°è¦ä½œæˆã•ã‚ŒãŸã¨ãã«å‹•ä½œã™ã‚‹å‡¦ç† */
const createContactTriggerFromFirestore = functions
  .region('asia-northeast1')
  .firestore.document('contacts/{contactId}')
  .onCreate(async (snapshot, context) => {
    const timestamp = snapshot.data().createdAt.seconds
    const date = new Date(parseInt(timestamp, 10) * 1000)
    const contact: Contact = {
      contactId: snapshot.id,
      contactTitle: snapshot.data().contactTitle,
      contactContent: snapshot.data().contactContent,
      contactFrom: snapshot.data().contactFrom,
      createdAt: date,
    }
    let message = 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è‡ªå‹•é€ä¿¡ã§ã™ã€‚\n'
    message += 'ä¸‹è¨˜ã®å†…å®¹ã®ãŠå•ã„åˆã‚ã›ãŒã‚ã‚Šã¾ã—ãŸã€‚\n\n'
    message += 'ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½\n'
    message += `ã‚¿ã‚¤ãƒˆãƒ«ã€€ã€€ã€€ã€€ï¼šã€€${contact.contactTitle}\n`
    message += `ãƒ¦ãƒ¼ã‚¶åã€€ã€€ã€€ã€€ï¼šã€€${contact.contactFrom.username}\n`
    message += `æ—¥æ™‚ã€€ã€€ã€€ã€€ã€€ã€€ï¼šã€€${format(
      contact.createdAt,
      'yyyyå¹´MMæœˆddæ—¥'
    )}\n`
    message += `å•ã„åˆã‚ã›å†…å®¹ã€€ï¼š\nã€€${contact.contactContent}\n`
    message += 'ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½\n'
    try {
      const mailOptions = {
        from: {é€ä¿¡å…ˆã®Gmail},
        to: {é€ä¿¡å…ƒã®Gmail},
        subject: {ãŠå•åˆã›ã®ã‚¿ã‚¤ãƒˆãƒ«},
        text: message,
      }

      await transporter.sendMail(mailOptions, (error, info) => {
        if (error) {
          return logColRef.add({
            status: 'error',
            message: error,
            createdAt: admin.firestore.FieldValue.serverTimestamp(),
          })
        }
        return logColRef.add({
          status: 'success',
          message: 'ãƒ¡ãƒ¼ãƒ«ãŒæ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸ',
          createdAt: admin.firestore.FieldValue.serverTimestamp(),
        })
      })
    } catch (error) {
      logColRef.add({
        status: 'error',
        message: error,
        createdAt: admin.firestore.FieldValue.serverTimestamp(),
      })
      return
    }
  })
```

firestoreã®ç™»éŒ²ãƒˆãƒªã‚¬ãƒ¼ã¯ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã§å®Ÿè£…ã§ãã‚‹ã‚ˆã†ã§ã™ã€‚
```typescript
functions
  .region('asia-northeast1')
  .firestore.document('contacts/{contactId}')
  .onCreate
```
ã“ã‚Œã‚’`users`ã¨ã‹ã«å¤‰ãˆã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶æƒ…å ±ãŒç™»éŒ²ã•ã‚ŒãŸã¨ãã«å‹•ä½œã•ã›ãŸã‚Šã§ãã¾ã™ã€‚
ã¾ãŸã€ç™»éŒ²ã ã‘ã§ãªãã€`onUpdate`ã‚„`onDelete`ã€`onWrite`ãªã©æ§˜ã€…ãªãƒˆãƒªã‚¬ãƒ¼ã¨ãªã‚‹å‡¦ç†ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚
https://firebase.google.com/docs/functions/firestore-events?hl=ja&gen=1st

ã“ã‚Œã§ã€ãŠå•åˆã›ãŒæ¥ã¦ã‚‚ã™ãã«å¯¾å¿œãŒã§ãã¦ã€å®›å…ˆã‚‚ã‚ã‹ã‚‹ã®ã§ã€ã™ãã«è¿”ä¿¡ã§ãã¡ã‚ƒã„ã¾ã™ã­ã€‚

# çµ‚ã‚ã‚Šã«
ä»Šå›ã¯ã€functionsã‚’ä½¿ã£ã¦ã€firestoreã®ç™»éŒ²ãƒˆãƒªã‚¬ãƒ¼ã‹ã‚‰Gmailé€ä¿¡ã¾ã§ã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚å°‘ã—ãšã¤functonsã‚’æ´»ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸæ°—ãŒã—ã¾ã™ã€‚
å°‘ã—ã§ã‚‚ã“ã®è¨˜äº‹ãŒãŠå½¹ã«ç«‹ã¦ã‚‹ã¨å¹¸ã„ã§ã™ã€‚ã¾ãŸé–“é•ã„ç­‰ã”ã–ã„ã¾ã—ãŸã‚‰ã€ã”æŒ‡æ‘˜ã®ã»ã©ãŠé¡˜ã„è‡´ã—ã¾ã™ã€‚
